<!-- templates/admin/analytics.html -->
{% extends "admin/base.html" %}
{% block page_title %}Analytics{% endblock %}
{% block content %}
<div class="row g-3 mb-4">
    <div class="col-12">
        <div class="table-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Daily Statistics</h5>
                <div class="btn-group">
                    <a href="?days=7" class="btn btn-sm {% if days == 7 %}btn-primary{% else %}btn-outline-primary{% endif %}">7 Days</a>
                    <a href="?days=30" class="btn btn-sm {% if days == 30 %}btn-primary{% else %}btn-outline-primary{% endif %}">30 Days</a>
                    <a href="?days=90" class="btn btn-sm {% if days == 90 %}btn-primary{% else %}btn-outline-primary{% endif %}">90 Days</a>
                </div>
            </div>
            <canvas id="dailyChart" height="80"></canvas>
        </div>
    </div>
</div>

<div class="row g-3">
    <div class="col-md-6">
        <div class="table-card">
            <h5 class="mb-3">Service Popularity</h5>
            <canvas id="serviceChart"></canvas>
        </div>
    </div>
    <div class="col-md-6">
        <div class="table-card">
            <h5 class="mb-3">Top Services</h5>
            <div class="list-group list-group-flush">
                {% for service, count in service_stats[:10] %}
                <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                    <span>{{ service or 'Unknown' }}</span>
                    <span class="badge bg-primary rounded-pill">{{ count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Daily Chart
const dailyCtx = document.getElementById('dailyChart');
new Chart(dailyCtx, {
    type: 'line',
    data: {
        labels: {{ daily_data | map(attribute='date') | list | tojson }},
        datasets: [{
            label: 'Incoming',
            data: {{ daily_data | map(attribute='incoming') | list | tojson }},
            borderColor: '#0dcaf0',
            backgroundColor: 'rgba(13, 202, 240, 0.1)',
        }, {
            label: 'Outgoing',
            data: {{ daily_data | map(attribute='outgoing') | list | tojson }},
            borderColor: '#198754',
            backgroundColor: 'rgba(25, 135, 84, 0.1)',
        }, {
            label: 'New Users',
            data: {{ daily_data | map(attribute='new_users') | list | tojson }},
            borderColor: '#ffc107',
            backgroundColor: 'rgba(255, 193, 7, 0.1)',
            yAxisID: 'y1',
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: { beginAtZero: true, position: 'left' },
            y1: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false } }
        }
    }
});

// Service Chart
const serviceCtx = document.getElementById('serviceChart');
new Chart(serviceCtx, {
    type: 'doughnut',
    data: {
        labels: {{ service_stats[:5] | map(attribute='0') | list | tojson }},
        datasets: [{
            data: {{ service_stats[:5] | map(attribute='1') | list | tojson }},
            backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#0dcaf0']
        }]
    }
});
</script>
{% endblock %}
